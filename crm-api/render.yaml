# Render Blueprint for CRM Pipeline API
# This file configures automatic deployment on Render
# https://render.com/docs/blueprint-spec

services:
  # ===========================================================================
  # Web Service - API
  # ===========================================================================
  - type: web
    name: crm-api
    runtime: node
    region: oregon # Change to your preferred region
    plan: free # Change to starter/pro for production
    branch: main
    buildCommand: npm install && npm run build
    startCommand: npm run start
    healthCheckPath: /health

    # Environment variables
    envVars:
      - key: NODE_ENV
        value: production

      - key: PORT
        value: 4000

      - key: MONGODB_URI
        fromDatabase:
          name: crm-mongodb
          property: connectionString

      - key: MONGODB_DB_NAME
        value: crm_api

      - key: REDIS_URL
        fromService:
          name: crm-redis
          type: pserv
          property: connectionString

      - key: JWT_SECRET
        generateValue: true # Auto-generates a secure secret

      - key: JWT_EXPIRES_IN
        value: 15m

      - key: JWT_REFRESH_SECRET
        generateValue: true

      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d

      - key: RATE_LIMIT_WINDOW_MS
        value: 60000

      - key: RATE_LIMIT_MAX_REQUESTS
        value: 100

      - key: GRAPHQL_DEPTH_LIMIT
        value: 10

      - key: GRAPHQL_COMPLEXITY_LIMIT
        value: 1000

      - key: INTROSPECTION_ENABLED
        value: false

      - key: PLAYGROUND_ENABLED
        value: false

      - key: LOG_LEVEL
        value: info

      - key: LOG_FORMAT
        value: json

      # CORS - IMPORTANT: Configure your frontend URLs
      - key: CORS_ORIGINS
        value: https://your-frontend.vercel.app,https://your-domain.com

      # Email configuration (optional)
      - key: EMAIL_PROVIDER
        value: console

      # Storage configuration
      - key: STORAGE_TYPE
        value: s3

      # Uncomment and configure for AWS S3
      # - key: AWS_S3_BUCKET
      #   value: your-bucket-name
      # - key: AWS_REGION
      #   value: us-east-1
      # - key: AWS_ACCESS_KEY_ID
      #   sync: false # Set manually in dashboard
      # - key: AWS_SECRET_ACCESS_KEY
      #   sync: false # Set manually in dashboard

  # ===========================================================================
  # Redis - Private instance
  # ===========================================================================
  - type: pserv
    name: crm-redis
    runtime: docker
    region: oregon
    plan: free # Change to starter for production
    dockerfilePath: ./docker/Dockerfile.redis
    dockerContext: ./docker
    envVars:
      - key: REDIS_MAXMEMORY
        value: 50mb

# ===========================================================================
# MongoDB - Using Render's managed MongoDB
# ===========================================================================
databases:
  - name: crm-mongodb
    region: oregon
    plan: free # Change to starter/pro for production
    databaseName: crm_api

# ===========================================================================
# Notes:
# - Free tier has limitations: 750 hours/month, sleeps after inactivity
# - For production, upgrade to Starter plan ($7/month)
# - Configure CORS_ORIGINS with your actual frontend URLs
# - Set AWS credentials manually in Render dashboard for S3 storage
# ===========================================================================
