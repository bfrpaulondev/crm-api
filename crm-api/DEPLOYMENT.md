# ðŸš€ Deployment Guide - CRM Pipeline API

## Quick Deploy to Render

### Step 1: Push to GitHub

```bash
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/crm-api.git
git push -u origin main
```

### Step 2: Create Render Blueprint

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click **New** â†’ **Blueprint**
3. Connect your GitHub repository
4. Render will detect `render.yaml`

### Step 3: Apply Configuration

Click **Apply** and Render will create:
- MongoDB database (free tier)
- Redis instance (private)
- Web service for the API

### Step 4: Update Environment Variables

After deployment, update these variables in the Render dashboard:

| Variable | What to Set |
|----------|-------------|
| `CORS_ORIGINS` | Your frontend URL (e.g., `https://myapp.vercel.app`) |
| `JWT_SECRET` | Should be auto-generated, verify it exists |
| `JWT_REFRESH_SECRET` | Should be auto-generated, verify it exists |

### Step 5: Create Database Indexes

Connect to your service shell and run:

```bash
npm run indexes:create
```

Or use Render's shell in the dashboard.

## Required Configuration Changes

Before going live, you MUST update these:

### 1. CORS Origins (CRITICAL!)

```
CORS_ORIGINS=https://your-frontend.vercel.app,https://your-domain.com
```

Without this, your frontend will get CORS errors!

### 2. JWT Secrets

These should be auto-generated by Render, but verify they exist and are at least 32 characters.

### 3. Email Provider (Optional but recommended)

```
EMAIL_PROVIDER=resend
RESEND_API_KEY=re_xxxxx
EMAIL_FROM=noreply@yourdomain.com
```

## Testing Your Deployment

### Health Check

```bash
curl https://your-api.onrender.com/health
```

### GraphQL Query

```bash
curl -X POST https://your-api.onrender.com/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __typename }"}'
```

### Register Tenant

```graphql
mutation {
  register(input: {
    email: "admin@example.com"
    password: "SecurePassword123!"
    firstName: "Admin"
    lastName: "User"
    tenantName: "My Company"
    tenantSlug: "my-company"
  }) {
    accessToken
    refreshToken
    user { id email }
    tenant { id name }
  }
}
```

## Troubleshooting

### 502 Bad Gateway
- Wait 2-3 minutes for service to start
- Check logs in Render dashboard

### CORS Errors
- Add your frontend URL to `CORS_ORIGINS`
- Include protocol: `https://` not just domain

### Authentication Fails
- Check if `JWT_SECRET` is set
- Token might be expired - try refresh token

### MongoDB Connection Error
- Wait for MongoDB to be ready (2-3 min)
- Check if `MONGODB_URI` is set correctly

## Production Checklist

- [ ] `CORS_ORIGINS` includes all frontend URLs
- [ ] `JWT_SECRET` and `JWT_REFRESH_SECRET` are set
- [ ] Database indexes created
- [ ] Email provider configured (optional)
- [ ] File storage configured (S3) if using uploads
- [ ] Monitoring enabled (Render provides basic metrics)

## Cost Estimate

| Service | Free Tier | Paid |
|---------|-----------|------|
| Web Service | Free (750h/month) | $7/month |
| MongoDB | Free (1GB) | $7/month |
| Redis | Free (25MB) | $10/month |

**Free tier limitations:**
- Services sleep after inactivity
- Limited resources
- Not suitable for production traffic

**Recommended for production:** Starter plan ($7/month for web service)

## Support

- Render Docs: https://render.com/docs
- Render Status: https://status.render.com
- GitHub Issues: Your repository issues
